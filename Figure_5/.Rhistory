d_scaled$Sample <- d$Sample
d_scaled$Patient <- str_split(d_scaled$Sample, "-", Inf, T)[,1]
# MLS LM
model_est_all <- data.frame()
for (i in stat_colnames) {
model <- lm(paste0(i, ' ~ MLS'), data = d)
model_est <- as.data.frame(t(summary(model)[["coefficients"]][2,]))
model_est$stat <- i
model_est_all <- rbind(model_est_all, model_est)
}
model_est_all %>% arrange(`Pr(>|t|)`)
model_est_all %>% arrange(`Pr(>|t|)`)
## MLS multivariate LM
fit.rel <- lm(MLS ~ 0 + ET.Rel + Edema.Rel + Necrosis.Rel + original_shape_Sphericity + original_shape_SurfaceVolumeRatio, data = d)
summary(fit.rel)
scale_factor <- 2
# Preparing data
d <- read.csv("data/IvyGap_MLS_Oncohabitats_V2.csv")
d <- d %>% mutate(MLS = (MLS.4 + MLS.5 + MLS.6 + MLS.7)/4)
d$Cavity.Rel <- NULL
stat_colnames <- colnames(d)[c(10:(ncol(d)-1))]
# MLS LM
model_est_all <- data.frame()
for (i in stat_colnames) {
model <- lm(paste0(i, ' ~ MLS'), data = d)
model_est <- as.data.frame(t(summary(model)[["coefficients"]][2,]))
model_est$stat <- i
model_est_all <- rbind(model_est_all, model_est)
}
model_est_all %>% arrange(`Pr(>|t|)`)
# Residualizing MLS
d_nona <- d %>% drop_na()
fit.svr <- lm(MLS ~ Edema.Rel, data = d_nona)
d_nona$MLS_resid <- residuals(fit.svr)
write.csv(d_nona, "results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
# MLS resid LM
model_est_all <- data.frame()
for (i in stat_colnames) {
model <- lm(paste0(i, ' ~ MLS_resid'), data = d_nona)
model_est <- as.data.frame(t(summary(model)[["coefficients"]][2,]))
model_est$stat <- i
model_est_all <- rbind(model_est_all, model_est)
}
model_est_all %>% arrange(`Pr(>|t|)`)
ivy_gex <- read.csv("data/gene_expression_details.csv")
ivy_gex <- ivy_gex %>% left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>% drop_na(MLS, expression_energy_le)
all_genes <- ivy_gex %>% group_by(gene_symbol) %>% summarise(count = n()) %>% filter(count > 100) %>% pull(gene_symbol)
ivy_gex <- read.csv("data/gene_expression_details.csv")
ivy_gex <- ivy_gex %>% left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>% drop_na(MLS, expression_energy_le)
all_genes <- ivy_gex %>% group_by(gene_symbol) %>% summarise(count = n()) %>% filter(count > 100) %>% pull(gene_symbol)
ivy_gex <- ivy_gex %>% mutate(Classification = if_else(MLS_resid > 0, "high", "low"))
le_ivy_gex <- ivy_gex %>%
filter(gene_symbol %in% all_genes) %>%
select(tumor_name, sub_block_name, gene_symbol, expression_energy_le, Classification) %>%
pivot_longer(expression_energy_le, names_to = "region", values_to = "expression_energy") %>%
group_by(gene_symbol, tumor_name)
stat.test <- le_ivy_gex %>%
group_by(gene_symbol) %>%
rstatix::t_test(expression_energy ~ Classification, paired = F) %>%
adjust_pvalue() %>%
add_significance("p.adj") %>%
add_xy_position(x = "Classification", fun = "mean_se") %>%
mutate(y.position = y.position+10) %>%
arrange(p.adj)
p <- ggbarplot(le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
x = "Classification",
y = "expression_energy",
add = c("mean_se"),
fill = "Classification",
facet.by = "gene_symbol",
ncol = 1,
scales = "free_y",
error.plot = "upper_errorbar") +
geom_point(data = le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
aes(x=Classification, y = expression_energy, fill=Classification), shape=21, alpha = 0.4, size=.1*scale_factor, position=position_jitter(height=0, width=0)) +
stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.005,  size=4*scale_factor, hide.ns=T) +
theme_cowplot(10*scale_factor) +
#facet_wrap(~gene_symbol, ncol=1, scales="free_y") +
#scale_y_continuous(limits = c(0, 100)) +
labs(y="ISH expr.", x = NULL) +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.text.y=element_text(size=12), axis.title.y = element_text(size=15), legend.position = "none", strip.background = element_blank(), strip.text = element_text(face = "bold", size=8*scale_factor)) +
scale_alpha_discrete(range = c(0.4,1)) +
scale_fill_manual(values = rev(c("red", "#4040FF")))
p
ivy_gex <- read.csv("data/gene_expression_details.csv")
ivy_gex <- ivy_gex %>% left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>% drop_na(MLS, expression_energy_le)
all_genes <- ivy_gex %>% group_by(gene_symbol) %>% summarise(count = n()) %>% filter(count > 100) %>% pull(gene_symbol)
ivy_gex <- ivy_gex %>% mutate(Classification = if_else(MLS_resid > 0, "high", "low"))
le_ivy_gex <- ivy_gex %>%
filter(gene_symbol %in% all_genes) %>%
select(tumor_name, sub_block_name, gene_symbol, expression_energy_le, Classification) %>%
pivot_longer(expression_energy_le, names_to = "region", values_to = "expression_energy") %>%
group_by(gene_symbol, tumor_name)
stat.test <- le_ivy_gex %>%
group_by(gene_symbol) %>%
rstatix::t_test(expression_energy ~ Classification, paired = F) %>%
adjust_pvalue() %>%
add_significance("p.adj") %>%
add_xy_position(x = "Classification", fun = "mean_se") %>%
mutate(y.position = y.position+10) %>%
arrange(p.adj)
p <- ggbarplot(le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
x = "Classification",
y = "expression_energy",
add = c("mean_se"),
fill = "Classification",
facet.by = "gene_symbol",
ncol = 1,
scales = "free_y",
error.plot = "upper_errorbar") +
geom_point(data = le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
aes(x=Classification, y = expression_energy, fill=Classification), shape=21, alpha = 0.4, size=.1*scale_factor, position=position_jitter(height=0, width=0)) +
stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.005,  size=4*scale_factor, hide.ns=T) +
theme_cowplot(10*scale_factor) +
#facet_wrap(~gene_symbol, ncol=1, scales="free_y") +
#scale_y_continuous(limits = c(0, 100)) +
labs(y="ISH expr.", x = NULL) +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.text.y=element_text(size=12), axis.title.y = element_text(size=15), legend.position = "none", strip.background = element_blank(), strip.text = element_text(face = "bold", size=8*scale_factor)) +
scale_alpha_discrete(range = c(0.4,1)) +
scale_fill_manual(values = rev(c("red", "#4040FF")))
p
ivy_gex <- read.csv("data/gene_expression_details.csv")
ivy_gex <- ivy_gex %>% left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>% drop_na(MLS, expression_energy_le)
all_genes <- ivy_gex %>% group_by(gene_symbol) %>% summarise(count = n()) %>% filter(count > 100) %>% pull(gene_symbol)
ivy_gex <- ivy_gex %>% mutate(Classification = if_else(MLS_resid > 0, "high", "low"))
le_ivy_gex <- ivy_gex %>%
filter(gene_symbol %in% all_genes) %>%
select(tumor_name, sub_block_name, gene_symbol, expression_energy_le, Classification) %>%
pivot_longer(expression_energy_le, names_to = "region", values_to = "expression_energy") %>%
group_by(gene_symbol, tumor_name)
stat.test <- le_ivy_gex %>%
group_by(gene_symbol) %>%
rstatix::t_test(expression_energy ~ Classification, paired = F) %>%
adjust_pvalue() %>%
add_significance("p.adj") %>%
add_xy_position(x = "Classification", fun = "mean_se") %>%
mutate(y.position = y.position+10) %>%
arrange(p.adj)
p <- ggbarplot(le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
x = "Classification",
y = "expression_energy",
add = c("mean_se"),
fill = "Classification",
facet.by = "gene_symbol",
ncol = 1,
scales = "free_y",
error.plot = "upper_errorbar") +
geom_point(data = le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
aes(x=Classification, y = expression_energy, fill=Classification), shape=21, alpha = 0.4, size=.1*scale_factor, position=position_jitter(height=0, width=0)) +
stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.005,  size=4*scale_factor, hide.ns=T) +
theme_cowplot(10*scale_factor) +
#facet_wrap(~gene_symbol, ncol=1, scales="free_y") +
#scale_y_continuous(limits = c(0, 100)) +
labs(y="ISH expr.", x = NULL) +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.text.y=element_text(size=12), axis.title.y = element_text(size=15), legend.position = "none", strip.background = element_blank(), strip.text = element_text(face = "bold", size=8*scale_factor)) +
scale_alpha_discrete(range = c(0.4,1)) +
scale_fill_manual(values = rev(c("red", "#4040FF")))
p
ivy_gex <- read.csv("data/gene_expression_details.csv")
ivy_gex <- ivy_gex %>% left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>% drop_na(MLS, expression_energy_le)
all_genes <- ivy_gex %>% group_by(gene_symbol) %>% summarise(count = n()) %>% filter(count > 100) %>% pull(gene_symbol)
ivy_gex <- ivy_gex %>% mutate(Classification = if_else(MLS_resid > 0, "high", "low"))
le_ivy_gex <- ivy_gex %>%
filter(gene_symbol %in% all_genes) %>%
select(tumor_name, sub_block_name, gene_symbol, expression_energy_le, Classification) %>%
pivot_longer(expression_energy_le, names_to = "region", values_to = "expression_energy") %>%
group_by(gene_symbol, tumor_name)
stat.test <- le_ivy_gex %>%
group_by(gene_symbol) %>%
rstatix::t_test(expression_energy ~ Classification, paired = F) %>%
adjust_pvalue() %>%
add_significance("p.adj") %>%
add_xy_position(x = "Classification", fun = "mean_se") %>%
mutate(y.position = y.position+10) %>%
arrange(p.adj)
p <- ggbarplot(le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
x = "Classification",
y = "expression_energy",
add = c("mean_se"),
fill = "Classification",
facet.by = "gene_symbol",
ncol = 1,
scales = "free_y",
error.plot = "upper_errorbar") +
geom_point(data = le_ivy_gex %>% filter(gene_symbol %in% stat.test[stat.test$p.adj<0.05,]$gene_symbol),
aes(x=Classification, y = expression_energy, fill=Classification), shape=21, alpha = 0.4, size=.1*scale_factor, position=position_jitter(height=0, width=0)) +
stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.005,  size=4*scale_factor, hide.ns=T) +
theme_cowplot(10*scale_factor) +
#facet_wrap(~gene_symbol, ncol=1, scales="free_y") +
#scale_y_continuous(limits = c(0, 100)) +
labs(y="ISH expr.", x = NULL) +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.text.y=element_text(size=12), axis.title.y = element_text(size=15), legend.position = "none", strip.background = element_blank(), strip.text = element_text(face = "bold", size=8*scale_factor)) +
scale_alpha_discrete(range = c(0.4,1)) +
scale_fill_manual(values = rev(c("red", "#4040FF")))
p
## Survival analysis
library(ggsurvfit)
library(survival)
library(survminer)
library(tidyverse)
library(rstatix)
library(cowplot)
patient_data <- read.csv("/Users/mzarodniuk/Documents/Scripts/TIME-Lab/Patzke_2024/data/Ivy_Gap/tumor_details.csv")
patient_data <- patient_data %>%
left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>%
mutate(Classification = if_else(MLS_resid > quantile(d_nona$MLS_resid, .50), "high", "low")) %>%
mutate(status = 1)
patient_data$age_in_years <- as.numeric(substr(patient_data$age_in_years, 1, 2))
patient_data <- patient_data %>% drop_na(Classification)
patient_data <- read.csv("/Users/mzarodniuk/Documents/Scripts/TIME-Lab/Patzke_2024/data/Ivy_Gap/tumor_details.csv")
patient_data <- patient_data %>%
left_join(d_nona %>% select(Sample, MLS_resid, MLS), by = c("tumor_name" = "Sample")) %>%
mutate(Classification = if_else(MLS_resid > quantile(d_nona$MLS_resid, .50), "high", "low")) %>%
mutate(status = 1)
patient_data$age_in_years <- as.numeric(substr(patient_data$age_in_years, 1, 2))
patient_data <- patient_data %>% drop_na(Classification)
p <- survfit(Surv(survival_days, status) ~ Classification, data = patient_data[!is.na(patient_data$survival_days),]) %>%
ggsurvplot(pval=T, legend = "none", risk.table=F, palette = c("#FF4040", "#4040FF"), xlab = "Time (days)", ylab = "OS (%)",
font.main = c(10*scale_factor, "plain", "black"),  ggtheme = theme_classic(10*scale_factor))
p
rstatix::chisq_test(table(as.numeric(patient_data$initial_kps>90), patient_data$Classification))
scale_factor <- 2
p <- ggboxplot(patient_data, x = "Classification",  y = "initial_kps", color = "Classification", palette = c("#FF4040", "#4040FF")) +
geom_dotplot(data = patient_data, aes(x = Classification, y = initial_kps, color = Classification, fill = Classification), dotsize=.75, binaxis = "y", stackdir = "center") +
#stat_pvalue_manual(stat.test, label = "p.adj.signif", size=4*scale_factor) +
theme_classic(10*scale_factor) +
labs(y="KPS", x = NULL) +
scale_y_continuous(limits = c(0, 110)) +
ggtitle("") +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), legend.position = "none") +
scale_color_manual(values = c("#FF4040", "#4040FF"))
p
count_mtx <- read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
library(org.Hs.eg.db)
count_mtx <- read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx$Geneid
count_mtx
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
keepY <- samples$structure=="LE"
bk.dat <- count_mtx[,keepY]
samples$structure
samples$structure=="LE"
samples$structure
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
drop_na(MLS) %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
keepY <- samples$structure=="LE"
bk.dat <- count_mtx[,keepY]
samples <- samples[keepY,]
dds <- DESeqDataSetFromMatrix(countData = bk.dat,
colData = samples,
design =  ~ Classification)
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = bk.dat,
colData = samples,
design =  ~ Classification)
bk.dat
bk.dat
samples
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
#drop_na(MLS) %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
dim(samples)
dim(count_mtx)
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
drop_na(structure) %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
drop_na(structure) %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
dim(samples)
keepY <- samples$structure=="LE"
bk.dat <- count_mtx[,keepY]
samples <- samples[keepY,]
dim(samples)
dim(bk.dat)
keepY
sum(keepY)
dim(samples)
count_mtx <- read_tsv("data/ivy_gap_rnaseq/counts_mtx.txt")
count_mtx$Geneid <- mapIds(org.Hs.eg.db,
keys=as.character(count_mtx$Geneid),
column="SYMBOL",
keytype="ENTREZID",
multiVals="first")
count_mtx <- count_mtx[!is.na(count_mtx$Geneid),]
count_mtx <- as.data.frame(count_mtx)
rownames(count_mtx) <- count_mtx$Geneid
count_mtx$Geneid <- NULL
samples = read_tsv("data/ivy_gap_rnaseq/columns-samples.tsv")
samples <- as.data.frame(samples)
rownames(samples) <- samples$rna_well_id
samples <- samples[colnames(count_mtx),]
classification <- read.csv("results/IvyGap_MLS_Oncohabitats_MLS_resid.csv")
classification <- classification[,2:ncol(classification)]
samples <- samples %>%
rownames_to_column() %>%
left_join(classification, by = c("tumor_name" = "Sample")) %>%
column_to_rownames() %>%
drop_na(structure) %>%
mutate(Classification = if_else(MLS_resid > quantile(classification$MLS_resid, .50), "high", "low"))
keepY <- samples$structure=="LE"
bk.dat <- count_mtx[,keepY]
samples <- samples[keepY,]
dds <- DESeqDataSetFromMatrix(countData = bk.dat,
colData = samples,
design =  ~ Classification)
smallestGroupSize <- 4
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
dds <- estimateSizeFactors(dds)
dds <- DESeq(dds)
vsd <- vst(dds)
plotPCA(vsd, intgroup="Classification")
res <- results(dds)
res <- results(dds, alpha = 0.05, contrast=c("Classification", "high", "low"))
as.data.frame(res) %>% filter(padj < 0.05)
library(clusterProfiler)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
dds <- DESeqDataSetFromMatrix(countData = bk.dat,
colData = samples,
design =  ~ Classification)
smallestGroupSize <- 4
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
dds <- estimateSizeFactors(dds)
dds <- DESeq(dds)
vsd <- vst(dds)
plotPCA(vsd, intgroup="Classification")
res <- results(dds)
res <- results(dds, alpha = 0.05, contrast=c("Classification", "high", "low"))
as.data.frame(res) %>% filter(padj < 0.05)
res$Entrezid <- mapIds(org.Hs.eg.db,
keys=rownames(res),
keytype="SYMBOL",
column="ENTREZID",
multiVals="first")
geneList <- res$log2FoldChange
names(geneList) <- as.character(res$Entrezid)
geneList <- sort(geneList, decreasing = TRUE)
m_df <- msigdbr(species = "Homo sapiens")
m_t2g <- msigdbr(species = "Homo sapiens", category = "H") %>% dplyr::select(gs_name, entrez_gene)
hallmarkGSEA <- GSEA(geneList, TERM2GENE = m_t2g, pvalueCutoff=1)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(rstatix)
library(patchwork)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(rstatix)
library(patchwork)
library(org.Hs.eg.db)
library(DESeq2)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
library(lemon)
library(cowplot)
hallmarkGSEA <- GSEA(geneList, TERM2GENE = m_t2g, pvalueCutoff=1)
hallmarkGSEA <- hallmarkGSEA %>% as.data.frame() %>% filter(p.adjust < 0.05)
hallmarkGSEA$Description_short <- unlist(lapply(hallmarkGSEA$Description, function(text, length = 45) {
if (nchar(text) > length) {
return(paste0(substr(text, 1, length), "..."))
} else {
return(text)
}
}))
hallmarkGSEA$ONTOLOGY_ID <- paste(hallmarkGSEA$ONTOLOGY, hallmarkGSEA$ID, sep = " ")
hallmarkGSEA$Enrichment_Group <- if_else(hallmarkGSEA$NES > 0, "high", "low")
hallmarkGSEA$logpadj <- -log10(hallmarkGSEA$p.adjust)
description_pos <- hallmarkGSEA %>%
mutate(Pos = if_else(NES < 0, .2, -.2))
hallmarkGSEA$Description_short <- gsub("HALLMARK_", "", hallmarkGSEA$Description_short)
p <- ggplot(hallmarkGSEA %>% head(20), aes(reorder(Description_short, NES), NES, fill = logpadj)) +
geom_col(position = "dodge", color='black', linewidth = 0.5) +
scale_fill_gradient2(
low = "white",
mid = "#FF4040",
high = "#FF4040",
midpoint = 8,
limits = c(0, 16)
) +
scale_color_gradient2(
low = "white",
mid = "#FF4040",
high = "#FF4040",
midpoint = 8,
limits = c(0, 16)
) +
#scale_fill_manual(values = (c("#FF4040", "#4040FF"))) +
#scale_color_manual(values = (c("#FF4040", "#4040FF"))) +
geom_text(data = hallmarkGSEA %>% head(20) %>% mutate(Dir = NES/abs(NES), FoldEnrichment_adj_abs = abs(NES)+0.05, FoldEnrichment_adj = FoldEnrichment_adj_abs*Dir), aes(x=Description_short, y = FoldEnrichment_adj, color=logpadj, label=Description_short), vjust=0.5, hjust = 0, size=2.5, color="black") +
#geom_text(data = description_pos %>% filter(Enrichment_Group == "low"), aes(x = Description_short, y = Pos, color = logpadj, label = Description_short), hjust = 0, size=3) +
#geom_text(data = description_pos %>% filter(Enrichment_Group == "high"), aes(x = Description_short, y = Pos, color = logpadj, label = Description_short), hjust = 1, size=3) +
xlab(NULL) +
ylab("NES") +
labs(fill = "logP") +
theme_cowplot(20) +
coord_capped_flip(bottom='both', left='none', right='both', top=brackets_horizontal(), ylim = c(0, 13)) +
theme(axis.text.y=element_blank(),
axis.ticks.y=element_blank())
p
